---
title: "VPNのいろいろ"
emoji: "🖋"
type: "tech"
topics: ["vpn"]
published: false
---

# 前書き

[ACCESS Advent Calender](https://qiita.com/advent-calendar/2021/access)の9日目は[@ten_takano](https://qiita.com/ten_takano)です。

*********************なんか前置き*********************

# そもそもVPNってなに？

この記事をご覧の方ならそれぐらい知っている！という方がほとんだとは思いますが、念の為まとめておきます。
VPN(Vertial Private Network)とはその名前の通り、仮想的にPrivate Networkを作るための技術やそれを実現するプロトコルスタックのことを指します。おそらくこんなケースで利用することがほとんどなのではないでしょうか。

- 外部に非公開なサーバーにプライベートネットワーク外からアクセスしたいとき
- 特定のIPアドレスからしかアクセスを許可していないサーバーにアクセスしたいとき
- フリーWi-Fiなどを利用しているがセキュリティが気になるとき（これが有効かどうかはさておき）

ちなみに私は１年のほとんどをリモートで仕事をしているので（お家サイコー！）、上記２つの目的のために日常的にVPNを利用しています。

VPNで接続されたネットワーク同士またはネットワークと端末は、あたかも同じPrivate Networkに接続されているかのように振る舞います。
普通のPrivate Networkに接続された端末を使用する場合を考えてみましょう。その端末では、Private Networkアドレスを使用して同じネットワークに接続されている別の端末を参照することができます。もしPrivate Network内にサーバーが立てられていたら、Private Networkアドレスを使用してそのサーバーへアクセスすることができます。端末から外部のサーバーへアクセスしようとしたら、NAT変換によって、そのPrivate Networkのゲートウェイを介してIPアドレスが変換されて目的のサーバーにアクセスされます。
では逆にインターネットから見た場合はどうでしょうか？Private Network内にあるサーバーには、ポートフォワーディングされていなければ直接アクセスすることはできません。Private Networkの構成がどのようになっているのかも知ることができません。また、言うまでもなく内部でどのような通信が行われているかも見ることはできません。
これらの特性を、物理的には同じPrivate Networkではないにもかかわらず、論理的に同じPrivate Networkとしてしまう機能を提供するのがVPNなのです。

これを実現するため、VPNは物理的にインターネットを情報が流れる際に、通信内容を暗号化・復号を行います。これにより第三者が通信内容を盗み見ようとしても復号ができないため、仮想的なPrivate Networkが実現されます。なので、

- 外部に非公開なサーバーでもVPNを接続すれば同じネットワーク内なのでアクセスすることができます
- アクセス制限がかけられているサーバーにも、接続元をVPNサーバーのあるネットワークのゲートウェイを通すことで制限を回避することができます
- フリーWi-Fiを利用している際に、VPNで通信を暗号化するため、通信を秘匿することが期待できます（設定による）

# VPNの利用のされ方

VPNには、ネットワーク同士を接続する「拠点間VPN」と呼ばれるものと、端末そのものをVPNサーバーに接続させる「リモートアクセスVPN」があります。
拠点間VPNはその名前の通り、遠く離れたオフィスなどのネットワーク同士を接続させるVPNです。拠点間VPNではネットワーク同士が接続されるので、各端末の利用者が利用時に何かを意識することはありません。どの端末がどちらのネットワークに接続されているかなども全く感知する必要はなく、あたかも同じ建物内に存在しているかのように利用することができます。利用者がすべきことはネットワーク管理者への感謝だけです。
これに対し、リモートアクセスVPNは利用する端末そのものをVPNサーバーへ接続するため、利用者が明示的に設定・操作を行う必要が有ります。

前置きがかなり長くなってしまいましたが、この先が本題です。この記事ではリモートアクセスVPNを利用する際に必要な知識を掘り下げていきます。

# VPNのプロトコル

VPNはトンネリングとカプセル化（暗号化）により実現されます。トンネリングとは2つの点を仮想的に直接接続する回線を確立することです。トンネリングによってオープンなネットワーク上に、外部から中を覗き見ることができない通り道を作ることができます。しかし、トンネリングだけでは、トンネル内部に侵入されてしまった場合、通信内容を盗聴されてしまう恐れが有ります。そこで、VPNはトンネル内を流すパケットをカプセル化（暗号化）します。これにより、万一トンネル内部に侵入されたとしてもパケットの中身を覗き見ることはできなくなります。

様々なVPNのプロトコルはこのトンネリングかカプセル化、またはその両方を行うように作られています。よく目にする（VPNの設定時に選択肢に現れる）プロトコルには以下のようなものがあります。

- PPTP
- L2TP/IPsec
- IPsec Xauth PSK
- IPsec Xauth RSA
- IKEv2

### PPTP

設定が簡単で速度が速いことが特徴。しかし、現在用いられている中で最もセキュリティが低く、脆弱性を抱えているため安全性にかけている。

### L2TP/IPsec

L2TPはトンネリングを行うプロトコルです。しかし、L2TPのみではカプセル化を行うことができません。IPSecもまたトンネリングを行うプロトコルです。ただし、IPsecはトンネリングだけでなくカプセル化も行うことができます。しかし、IPsecはマルチキャストを行うことができません。このようなそれぞれの足りない部分を補い合わせるため、IPsecと別のトンネリングプロトコルを組み合わせて使うということが行われます。（名前としてIPsecがない場合でも使われている場合が有ります）
セキュリティが高いためよく使われていましたが、動作が重いため少しずつ使われなくなっていくと思います。

### IPsec Xauth PSK/RSA

拠点間VPNの場合、接続する機器同士がそれぞれラックなどに設置された機器である場合にはここまでで説明した内容で十分ですが、リモートアクセスVPNの場合にはPCの紛失などによりVPNを不正に使用されてしまう危険性があります。そのため、機器の認証に加えて、ユーザーが正当であるかを認証するために、Xauthというプロトコルを使用してユーザー認証を行うプロトコルです。
ちなみに、PSK/RSAは機器の認証に用いるもので、それぞれ事前に共有鍵を共有しておくPSK（Pre Shared Key）、証明書をつかうRSAが選べます。

### IKEv2

IPsecでは認証部分をIKEというプロトコルで行っています。IKEv2ということは全身となるIKEv1というものがあるのですが、こちらは選択肢として見ることはあまりないように思います。IKEv2はIKEv1をより高速によりセキュアにするための改良が加えられたプロトコルで、2021年現在で比較的新しいプロトコルです。（新しいためあまり見ることがありません）
こちらもIKEv2という名前にはなっていますが、相変わらずIPsecを利用しています。

### その他

そもそもここまでIPsecを利用するプロトコルを多く利用していましたが、IPsec以外にも暗号化を行えるプロトコルが有ります。超有名なSSLですね。SSLを利用したVPNは一般的にSSL-VPNと呼ばれていて、IPsecと異なりWebブラウザを利用して通信します。そのため、OS標準の機能で提供されることはなく、Webブラウザの拡張機能として機能をインストールして使うことになります。

# あとがき

********************締めのなにか**********************

明日は[@krmtmint](https://qiita.com/krmtmint)さんの投稿です。お楽しみに！！
